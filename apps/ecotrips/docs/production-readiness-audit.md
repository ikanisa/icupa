# ecoTrips Production Go-Live Audit

_Last updated: 2025-10-14_

## Executive Summary
- The public-facing Next.js application is still the default scaffold and does not yet express ecoTrips messaging, navigation, or conversion flows, so it is not production ready for travellers.【F:app/app/page.tsx†L1-L103】【F:app/app/layout.tsx†L1-L33】
- The operator console has strong authentication guards and Supabase integration scaffolding, but most pages remain fixture-backed previews without live data actions, limiting day-2 operational readiness.【F:ops/console/lib/auth.ts†L29-L150】【F:ops/console/app/ops/manifests/page.tsx†L206-L371】
- Edge functions demonstrate thoughtful observability and ledger hooks, yet payments and telemetry paths still assume happy paths and rely on manual environment hardening before launch.【F:supabase/functions/bff-checkout/index.ts†L6-L335】【F:supabase/functions/_obs/withObs.ts†L29-L186】

## Strengths Observed
- Consistent observability wrapper ensures audit logs, request IDs, and JSON error envelopes across Supabase edge functions.【F:supabase/functions/_obs/withObs.ts†L29-L186】
- Payments checkout flow validates payloads, enforces currency allow-listing, persists metadata, and logs ledger intents, covering many fraud/duplication risks upfront.【F:supabase/functions/bff-checkout/index.ts†L20-L335】
- Operator console enforces persona-based access control via Supabase, with offline bypass only when explicitly toggled, reducing accidental exposure of back-office tooling.【F:ops/console/lib/env.ts†L29-L37】【F:ops/console/lib/auth.ts†L29-L150】
- Production readiness checklist and contract smoke tests already exist, documenting required secrets and validating key edge functions once credentials are provided.【F:ops/PRODUCTION_READINESS.md†L1-L58】【F:tools/tests/contracts.mjs†L1-L105】

## Detailed Findings

### Front-End (Traveller App)
1. **Placeholder experience** – The root page still shows the Create Next App demo content, CTA links to Vercel/Next.js, and lacks ecoTrips navigation, branding, or itinerary flows.【F:app/app/page.tsx†L1-L103】
2. **Metadata defaults** – Document metadata remains "Create Next App"/"Generated by create next app", which hurts SEO and brand trust.【F:app/app/layout.tsx†L1-L33】
3. **No QA automation hooks** – The package exposes only dev/build/start scripts and lacks lint/test tooling, making regressions likely.【F:app/package.json†L1-L23】

### Front-End (Ops Console)
1. **Fixture-first views** – Each operations page falls back to JSON fixtures unless environment variables and Supabase cookies are present, so the UI does not yet render live production data by default.【F:ops/console/app/ops/manifests/page.tsx†L248-L325】【F:ops/console/app/ops/exceptions/page.tsx†L124-L210】【F:ops/console/app/ops/refunds/page.tsx†L304-L382】【F:ops/console/app/ops/supplier-slas/page.tsx†L172-L240】
2. **Limited layout system** – Styling relies on inline CSS objects and a minimal global stylesheet without shared components, risking inconsistent UX when the surface area grows.【F:ops/console/app/ops/manifests/page.tsx†L122-L199】【F:ops/console/app/globals.css†L1-L40】
3. **Navigation affordances** – The layout renders an unstyled link row without active/hover states or breadcrumbs, which may confuse operators managing multiple queues.【F:ops/console/app/ops/layout.tsx†L1-L23】
4. **Action stubs** – Server actions such as `createRefundAction` call Supabase but provide only toast-level feedback; there is no optimistic state, audit log surfacing, or in-app confirmation modal yet.【F:ops/console/app/ops/refunds/page.tsx†L617-L811】
5. **Vision vs. implementation gap** – The console plan outlines richer interactions (detail drawers, escalations), while current pages present static bullet lists describing intent instead of actual widgets, signalling unfinished scope.【F:ops/console/PLAN.md†L11-L43】【F:ops/console/app/ops/manifests/page.tsx†L75-L244】

### Back-End / Supabase Edge Functions
1. **Stripe coverage gaps** – Checkout only maps a subset of Stripe statuses (`succeeded`, `canceled`, `payment_failed`) and defaults everything else to `processing`, so edge cases like `requires_action` or `requires_payment_method` may not reconcile correctly.【F:supabase/functions/bff-checkout/index.ts†L322-L334】
2. **Mock fallbacks** – When Stripe errors occur the function silently falls back to mock mode, which is valuable for resilience but risks masking credential issues in production without alerting or circuit breaking.【F:supabase/functions/bff-checkout/index.ts†L237-L291】
3. **Strong dependency on service role** – Finance helpers and metrics increments require service-role keys at runtime; accidental misconfiguration results in runtime throws rather than graceful health degradation.【F:supabase/functions/_shared/fin.ts†L1-L41】【F:supabase/functions/metrics-incr/index.ts†L1-L69】
4. **Observability destinations** – Logs are JSON-encoded to stdout, but there is no built-in shipping to external telemetry or alerting integration (e.g., Honeycomb, Datadog), so operators must ensure platform log drains before go-live.【F:supabase/functions/_obs/withObs.ts†L29-L186】

### Platform, Operations, and Testing
1. **Environment toggles** – Launch relies on manually setting many secret flags (`STRIPE_*`, `WA_*`, Hotelbeds credentials) per the checklist; automation or terraform is not present in-repo, so infrastructure-as-code remains an external dependency.【F:ops/PRODUCTION_READINESS.md†L5-L33】
2. **CI smoke limitations** – Contract tests require staging credentials to execute; without them CI will exit early, so pipeline enforcement must supply secrets or a mocked Supabase test project.【F:tools/tests/contracts.mjs†L11-L105】
3. **Offline bypass flags** – Both edge functions and the console include offline toggles (`USE_FIXTURES`, `OPS_CONSOLE_BYPASS_AUTH`), increasing risk if accidentally left enabled in production deployments.【F:ops/PRODUCTION_READINESS.md†L11-L31】【F:ops/console/lib/env.ts†L29-L37】

## Outstanding Items Before Go-Live
| Priority | Area | Description | References |
| --- | --- | --- | --- |
| P0 | Traveller Web | Replace the default Next.js landing page with ecoTrips IA, marketing copy, navigation, and booking entry points.【F:app/app/page.tsx†L1-L103】 |
| P0 | Ops Console | Wire manifests/exceptions/refunds/SLAs views to live Supabase data with empty states, pagination, and error handling instead of fixture copy blocks.【F:ops/console/app/ops/manifests/page.tsx†L206-L371】【F:ops/console/app/ops/exceptions/page.tsx†L124-L210】【F:ops/console/app/ops/refunds/page.tsx†L304-L382】【F:ops/console/app/ops/supplier-slas/page.tsx†L172-L240】 |
| P0 | Payments | Expand checkout status handling (`requires_action`, `requires_payment_method`, async capture) and surface non-mock Stripe failures via alerts/metrics to avoid silent degradation.【F:supabase/functions/bff-checkout/index.ts†L237-L334】 |
| P1 | UX System | Establish shared component library/design tokens for the ops console to remove verbose inline styles and ensure accessibility (focus states, contrast, responsive layout).【F:ops/console/app/ops/manifests/page.tsx†L122-L199】【F:ops/console/app/globals.css†L1-L40】 |
| P1 | Testing | Add lint/test/visual regression coverage for both web apps so CI protects against layout regressions and auth bugs.【F:app/package.json†L1-L23】【F:ops/console/package.json†L1-L24】 |
| P1 | Telemetry | Connect observability logs to managed logging/alerting and add golden-signal dashboards per the ops observability plan.【F:supabase/functions/_obs/withObs.ts†L29-L186】【F:ops/PRODUCTION_READINESS.md†L33-L49】 |
| P2 | Console UX | Implement in-app feedback loops (toasts, audit timelines, bulk actions) described in the console plan, replacing placeholder bullet lists with interactive components.【F:ops/console/PLAN.md†L11-L43】【F:ops/console/app/ops/manifests/page.tsx†L75-L244】 |
| P2 | Secrets Hygiene | Automate environment provisioning (Terraform or Supabase CLI flows) so the long checklist of secrets cannot drift between environments.【F:ops/PRODUCTION_READINESS.md†L5-L33】 |

## Phased Implementation Plan

### Phase 0 – Launch Blockers (1-2 sprints)
- Build the traveller marketing/booking shell with updated metadata, brand assets, and primary conversion flows (hero, itinerary CTA, footer) replacing the scaffold content.【F:app/app/page.tsx†L1-L103】【F:app/app/layout.tsx†L1-L33】
- Connect ops console tables to Supabase RPC/views, add pagination/loading/error states, and ensure offline fixtures are disabled in production environments.【F:ops/console/app/ops/manifests/page.tsx†L248-L371】【F:ops/console/lib/env.ts†L29-L37】
- Harden `bff-checkout` to handle additional Stripe statuses, emit explicit alerts when falling back to mock mode, and document rollback procedures in the runbook.【F:supabase/functions/bff-checkout/index.ts†L237-L334】
- Provide CI with staging Supabase credentials so `npm run test:ci` gates merges, preventing silent test skips.【F:tools/tests/contracts.mjs†L11-L105】

### Phase 1 – Pre-Launch Polish (next sprint)
- Introduce a shared design system for the console (buttons, tables, badges) and enforce accessibility/focus rules across layouts.【F:ops/console/app/globals.css†L1-L40】【F:ops/console/app/ops/manifests/page.tsx†L122-L199】
- Implement richer operator workflows: detail drawers with actual Supabase data, retry/escalate actions, and confirmation modals aligning with the plan doc.【F:ops/console/PLAN.md†L11-L43】【F:ops/console/app/ops/refunds/page.tsx†L617-L811】
- Wire observability output to the chosen monitoring stack and add synthetic checks/alerts per the production readiness checklist.【F:supabase/functions/_obs/withObs.ts†L29-L186】【F:ops/PRODUCTION_READINESS.md†L33-L49】
- Add automated lint/unit/UI testing for both apps (Playwright/RTL) and codify commands in package scripts for CI reuse.【F:app/package.json†L1-L23】【F:ops/console/package.json†L1-L24】

### Phase 2 – Post-Go-Live Enhancements
- Expand console analytics (SLA trends, refund KPIs) and integrate audit trails visible from the UI, replacing bullet-point placeholders with live dashboards.【F:ops/console/app/ops/supplier-slas/page.tsx†L70-L199】
- Automate infrastructure/secret management (e.g., GitOps for Supabase edge deployments, Vercel env sync) to reduce manual checklists.【F:ops/PRODUCTION_READINESS.md†L5-L58】
- Iterate on customer telemetry: connect client-side analytics, session replay (if approved), and integrate privacy workflows with the existing Supabase privacy functions.【F:ops/PRODUCTION_READINESS.md†L44-L49】

---
This audit should accompany code review and design sign-off during the go-live readiness checkpoint.
